{"version":3,"file":"index.js","sources":["../src/utils/builtIns.js","../src/index.js"],"sourcesContent":["export default {\n  require: (input) => input.trim().length > 0,\n  email: (input) => /^\\w+([-]?\\w+)*@\\w+([-]?\\w+)*(\\.\\w{2,3})+$/.test(input),\n  minLen: (input, len) => input.toString().length < len\n}\n","import { useRef, useState, useEffect, createRef } from 'react'\nimport builtInValidators from './utils/builtIns'\n\nexport const useValidator = (config) => {\n  console.log('rerender useValidator')\n  const elements = useRef(new Map())\n  const touchedElements = useRef(new Map())\n  const dirtyElements = useRef(new Map())\n  const errors = useRef({})\n  const customValidators = useRef(null)\n  const [validity, setValidity] = useState(true)\n\n  const submitForm = (fn) => (e) => {\n    e.preventDefault()\n    console.log('validator formSubmit')\n    for (const el of elements) {\n      fieldValidation(el)\n    }\n    fn()\n  }\n\n  useEffect(() => {\n    if (config.customValidators) {\n      customValidators.current = config.customValidators\n    }\n  }, [])\n\n  // const beforeSubmit = () => {\n  //   // TODO: run all inputs before submit\n  // }\n\n  const fieldValidation = (ref) => {\n    let _isValid = true\n    const { data } = elements.current.get(ref.current)\n    const validators = getValidators(\n      data,\n      customValidators.current,\n      builtInValidators\n    )\n    const { rules, msgs } = data\n    for (const key in validators) {\n      const validator = validators[key]\n      const name = ref.current.name\n      if (rules[key] && !validator(ref.current.value)) {\n        // errors.current[name] = [\n        //   msgs?.[key],\n        //   ...(errors.current[name] ? [errors.current[name]] : [])\n        // ]\n        errors.current[name] = { [key]: msgs?.[key], ...errors.current[name] }\n        _isValid = false\n      } else {\n        console.log(errors.current[name])\n        delete errors.current?.[name]?.[key]\n        _isValid = true\n      }\n    }\n    return _isValid\n  }\n\n  const keyup = (ref) => (e) => {\n    console.log(e)\n    if (!dirtyElements.current.has(ref)) {\n      dirtyElements.current.set(ref)\n      return\n    }\n    console.log(e)\n    const v = fieldValidation(ref)\n    if (validity !== v) {\n      setValidity((v) => !v)\n    }\n  }\n\n  const getValidators = (data, configValidators, builtInValidators) => {\n    if (!data) return\n    const f = {}\n    for (const key in data?.rules) {\n      console.log(key)\n      const t = checkForValidators(\n        data,\n        configValidators,\n        builtInValidators,\n        key\n      )\n      console.log(t)\n      if (t) {\n        f[key] = t\n      }\n    }\n    return f\n  }\n\n  const checkForValidators = (\n    data,\n    configValidators,\n    builtInValidators,\n    name\n  ) => {\n    if (data.customValidators?.[name]) {\n      return data.customValidators[name]\n    }\n    if (configValidators?.[name]) {\n      return configValidators[name]\n    }\n    if (builtInValidators[name]) {\n      return builtInValidators[name]\n    } else {\n      throw new Error(`no validation function with mane ${name}`)\n    }\n  }\n\n  const track = (elem, rules) => {\n    if (!elem) return\n    const ref = createRef()\n    if (elements.current.has(ref)) return\n\n    ref.current = elem\n    elements.current.set(elem, {\n      valid: true,\n      ...(rules && { data: rules })\n    })\n    // ref.current.onchange = keyup(ref)\n    // ref.current.onchange = partialOnChange(ref)\n    // ref.current.onfocus = partialOnFocus(ref)\n    ref.current.addEventListener('focus', partialOnFocus(ref))\n    ref.current.addEventListener('input', keyup(ref))\n  }\n\n  // const partialOnChange = (ref) => (e) => {\n  //    dirtyElements.current.set(ref)\n  //   ref.current.onchange = ''\n  // }\n\n  const partialOnFocus = (ref) => (e) => {\n    console.log('partial focus')\n    touchedElements.current.set(ref)\n    ref.current.onfocus = ''\n  }\n\n  return [track, submitForm, errors.current]\n}\n"],"names":["require","input","trim","length","email","test","minLen","len","toString","useValidator","config","console","log","elements","useRef","Map","touchedElements","dirtyElements","errors","customValidators","useState","validity","setValidity","submitForm","fn","e","preventDefault","el","fieldValidation","useEffect","current","ref","_isValid","get","data","validators","getValidators","builtInValidators","rules","msgs","key","validator","name","value","keyup","has","set","v","configValidators","f","t","checkForValidators","Error","track","elem","createRef","valid","addEventListener","partialOnFocus","onfocus"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,wBAAe;AACbA,EAAAA,OAAO,EAAE,iBAACC,KAAD;AAAA,WAAWA,KAAK,CAACC,IAAN,GAAaC,MAAb,GAAsB,CAAjC;AAAA,GADI;AAEbC,EAAAA,KAAK,EAAE,eAACH,KAAD;AAAA,WAAW,4CAA4CI,IAA5C,CAAiDJ,KAAjD,CAAX;AAAA,GAFM;AAGbK,EAAAA,MAAM,EAAE,gBAACL,KAAD,EAAQM,GAAR;AAAA,WAAgBN,KAAK,CAACO,QAAN,GAAiBL,MAAjB,GAA0BI,GAA1C;AAAA;AAHK,CAAf;;ICGaE,YAAY,GAAG,SAAfA,YAAe,CAACC,MAAD,EAAY;AACtCC,EAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ;AACA,MAAMC,QAAQ,GAAGC,YAAM,CAAC,IAAIC,GAAJ,EAAD,CAAvB;AACA,MAAMC,eAAe,GAAGF,YAAM,CAAC,IAAIC,GAAJ,EAAD,CAA9B;AACA,MAAME,aAAa,GAAGH,YAAM,CAAC,IAAIC,GAAJ,EAAD,CAA5B;AACA,MAAMG,MAAM,GAAGJ,YAAM,CAAC,EAAD,CAArB;AACA,MAAMK,gBAAgB,GAAGL,YAAM,CAAC,IAAD,CAA/B;;AANsC,kBAONM,cAAQ,CAAC,IAAD,CAPF;AAAA,MAO/BC,QAP+B;AAAA,MAOrBC,WAPqB;;AAStC,MAAMC,UAAU,GAAG,SAAbA,UAAa,CAACC,EAAD;AAAA,WAAQ,UAACC,CAAD,EAAO;AAChCA,MAAAA,CAAC,CAACC,cAAF;AACAf,MAAAA,OAAO,CAACC,GAAR,CAAY,sBAAZ;;AACA,2DAAiBC,QAAjB,wCAA2B;AAAA,YAAhBc,EAAgB;AACzBC,QAAAA,eAAe,CAACD,EAAD,CAAf;AACD;;AACDH,MAAAA,EAAE;AACH,KAPkB;AAAA,GAAnB;;AASAK,EAAAA,eAAS,CAAC,YAAM;AACd,QAAInB,MAAM,CAACS,gBAAX,EAA6B;AAC3BA,MAAAA,gBAAgB,CAACW,OAAjB,GAA2BpB,MAAM,CAACS,gBAAlC;AACD;AACF,GAJQ,EAIN,EAJM,CAAT;;AAUA,MAAMS,eAAe,GAAG,SAAlBA,eAAkB,CAACG,GAAD,EAAS;AAC/B,QAAIC,QAAQ,GAAG,IAAf;;AAD+B,gCAEdnB,QAAQ,CAACiB,OAAT,CAAiBG,GAAjB,CAAqBF,GAAG,CAACD,OAAzB,CAFc;AAAA,QAEvBI,IAFuB,yBAEvBA,IAFuB;;AAG/B,QAAMC,UAAU,GAAGC,aAAa,CAC9BF,IAD8B,EAE9Bf,gBAAgB,CAACW,OAFa,EAG9BO,iBAH8B,CAAhC;AAH+B,QAQvBC,KARuB,GAQPJ,IARO,CAQvBI,KARuB;AAAA,QAQhBC,IARgB,GAQPL,IARO,CAQhBK,IARgB;;AAS/B,SAAK,IAAMC,GAAX,IAAkBL,UAAlB,EAA8B;AAC5B,UAAMM,SAAS,GAAGN,UAAU,CAACK,GAAD,CAA5B;AACA,UAAME,IAAI,GAAGX,GAAG,CAACD,OAAJ,CAAYY,IAAzB;;AACA,UAAIJ,KAAK,CAACE,GAAD,CAAL,IAAc,CAACC,SAAS,CAACV,GAAG,CAACD,OAAJ,CAAYa,KAAb,CAA5B,EAAiD;AAAA;;AAK/CzB,QAAAA,MAAM,CAACY,OAAP,CAAeY,IAAf,wCAA0BF,GAA1B,IAAgCD,IAAhC,aAAgCA,IAAhC,uBAAgCA,IAAI,CAAGC,GAAH,CAApC,cAAgDtB,MAAM,CAACY,OAAP,CAAeY,IAAf,CAAhD;AACAV,QAAAA,QAAQ,GAAG,KAAX;AACD,OAPD,MAOO;AAAA;;AACLrB,QAAAA,OAAO,CAACC,GAAR,CAAYM,MAAM,CAACY,OAAP,CAAeY,IAAf,CAAZ;AACA,2BAAOxB,MAAM,CAACY,OAAd,0EAAO,gBAAiBY,IAAjB,CAAP,8DAAO,qBAAyBF,GAAzB,CAAP;AACAR,QAAAA,QAAQ,GAAG,IAAX;AACD;AACF;;AACD,WAAOA,QAAP;AACD,GA1BD;;AA4BA,MAAMY,KAAK,GAAG,SAARA,KAAQ,CAACb,GAAD;AAAA,WAAS,UAACN,CAAD,EAAO;AAC5Bd,MAAAA,OAAO,CAACC,GAAR,CAAYa,CAAZ;;AACA,UAAI,CAACR,aAAa,CAACa,OAAd,CAAsBe,GAAtB,CAA0Bd,GAA1B,CAAL,EAAqC;AACnCd,QAAAA,aAAa,CAACa,OAAd,CAAsBgB,GAAtB,CAA0Bf,GAA1B;AACA;AACD;;AACDpB,MAAAA,OAAO,CAACC,GAAR,CAAYa,CAAZ;AACA,UAAMsB,CAAC,GAAGnB,eAAe,CAACG,GAAD,CAAzB;;AACA,UAAIV,QAAQ,KAAK0B,CAAjB,EAAoB;AAClBzB,QAAAA,WAAW,CAAC,UAACyB,CAAD;AAAA,iBAAO,CAACA,CAAR;AAAA,SAAD,CAAX;AACD;AACF,KAXa;AAAA,GAAd;;AAaA,MAAMX,aAAa,GAAG,SAAhBA,aAAgB,CAACF,IAAD,EAAOc,gBAAP,EAAyBX,iBAAzB,EAA+C;AACnE,QAAI,CAACH,IAAL,EAAW;AACX,QAAMe,CAAC,GAAG,EAAV;;AACA,SAAK,IAAMT,GAAX,IAAkBN,IAAlB,aAAkBA,IAAlB,uBAAkBA,IAAI,CAAEI,KAAxB,EAA+B;AAC7B3B,MAAAA,OAAO,CAACC,GAAR,CAAY4B,GAAZ;AACA,UAAMU,CAAC,GAAGC,kBAAkB,CAC1BjB,IAD0B,EAE1Bc,gBAF0B,EAG1BX,iBAH0B,EAI1BG,GAJ0B,CAA5B;AAMA7B,MAAAA,OAAO,CAACC,GAAR,CAAYsC,CAAZ;;AACA,UAAIA,CAAJ,EAAO;AACLD,QAAAA,CAAC,CAACT,GAAD,CAAD,GAASU,CAAT;AACD;AACF;;AACD,WAAOD,CAAP;AACD,GAjBD;;AAmBA,MAAME,kBAAkB,GAAG,SAArBA,kBAAqB,CACzBjB,IADyB,EAEzBc,gBAFyB,EAGzBX,iBAHyB,EAIzBK,IAJyB,EAKtB;AAAA;;AACH,iCAAIR,IAAI,CAACf,gBAAT,0DAAI,sBAAwBuB,IAAxB,CAAJ,EAAmC;AACjC,aAAOR,IAAI,CAACf,gBAAL,CAAsBuB,IAAtB,CAAP;AACD;;AACD,QAAIM,gBAAJ,aAAIA,gBAAJ,uBAAIA,gBAAgB,CAAGN,IAAH,CAApB,EAA8B;AAC5B,aAAOM,gBAAgB,CAACN,IAAD,CAAvB;AACD;;AACD,QAAIL,iBAAiB,CAACK,IAAD,CAArB,EAA6B;AAC3B,aAAOL,iBAAiB,CAACK,IAAD,CAAxB;AACD,KAFD,MAEO;AACL,YAAM,IAAIU,KAAJ,uCAA8CV,IAA9C,CAAN;AACD;AACF,GAjBD;;AAmBA,MAAMW,KAAK,GAAG,SAARA,KAAQ,CAACC,IAAD,EAAOhB,KAAP,EAAiB;AAC7B,QAAI,CAACgB,IAAL,EAAW;AACX,QAAMvB,GAAG,GAAGwB,eAAS,EAArB;AACA,QAAI1C,QAAQ,CAACiB,OAAT,CAAiBe,GAAjB,CAAqBd,GAArB,CAAJ,EAA+B;AAE/BA,IAAAA,GAAG,CAACD,OAAJ,GAAcwB,IAAd;AACAzC,IAAAA,QAAQ,CAACiB,OAAT,CAAiBgB,GAAjB,CAAqBQ,IAArB;AACEE,MAAAA,KAAK,EAAE;AADT,OAEMlB,KAAK,IAAI;AAAEJ,MAAAA,IAAI,EAAEI;AAAR,KAFf;AAOAP,IAAAA,GAAG,CAACD,OAAJ,CAAY2B,gBAAZ,CAA6B,OAA7B,EAAsCC,cAAc,CAAC3B,GAAD,CAApD;AACAA,IAAAA,GAAG,CAACD,OAAJ,CAAY2B,gBAAZ,CAA6B,OAA7B,EAAsCb,KAAK,CAACb,GAAD,CAA3C;AACD,GAfD;;AAsBA,MAAM2B,cAAc,GAAG,SAAjBA,cAAiB,CAAC3B,GAAD;AAAA,WAAS,UAACN,CAAD,EAAO;AACrCd,MAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ;AACAI,MAAAA,eAAe,CAACc,OAAhB,CAAwBgB,GAAxB,CAA4Bf,GAA5B;AACAA,MAAAA,GAAG,CAACD,OAAJ,CAAY6B,OAAZ,GAAsB,EAAtB;AACD,KAJsB;AAAA,GAAvB;;AAMA,SAAO,CAACN,KAAD,EAAQ9B,UAAR,EAAoBL,MAAM,CAACY,OAA3B,CAAP;AACD,CAxIM;;;;"}