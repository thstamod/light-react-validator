{"version":3,"file":"index.modern.js","sources":["../src/utils/builtIns.js","../src/index.js"],"sourcesContent":["export default {\n  require: (input) => input.trim().length > 0,\n  email: (input) => /^\\w+([-]?\\w+)*@\\w+([-]?\\w+)*(\\.\\w{2,3})+$/.test(input),\n  minLen: (input, len) => input.toString().length < len\n}\n","import { useRef, useState, useEffect, createRef } from 'react'\nimport builtInValidators from './utils/builtIns'\n\nexport const useValidator = (config) => {\n  console.log('rerender useValidator')\n  const elements = useRef(new Map())\n  const touchedElements = useRef(new Map())\n  const dirtyElements = useRef(new Map())\n  const errors = useRef({})\n  const customValidators = useRef(null)\n  const [validity, setValidity] = useState(true)\n\n  const submitForm = (fn) => (e) => {\n    e.preventDefault()\n    console.log('validator formSubmit')\n    for (const el of elements) {\n      fieldValidation(el)\n    }\n    fn()\n  }\n\n  useEffect(() => {\n    if (config.customValidators) {\n      customValidators.current = config.customValidators\n    }\n  }, [])\n\n  // const beforeSubmit = () => {\n  //   // TODO: run all inputs before submit\n  // }\n\n  const fieldValidation = (ref) => {\n    let _isValid = true\n    const { data } = elements.current.get(ref.current)\n    const validators = getValidators(\n      data,\n      customValidators.current,\n      builtInValidators\n    )\n    const { rules, msgs } = data\n    for (const key in validators) {\n      const validator = validators[key]\n      const name = ref.current.name\n      if (rules[key] && !validator(ref.current.value)) {\n        // errors.current[name] = [\n        //   msgs?.[key],\n        //   ...(errors.current[name] ? [errors.current[name]] : [])\n        // ]\n        errors.current[name] = { [key]: msgs?.[key], ...errors.current[name] }\n        _isValid = false\n      } else {\n        console.log(errors.current[name])\n        delete errors.current?.[name]?.[key]\n        _isValid = true\n      }\n    }\n    return _isValid\n  }\n\n  const keyup = (ref) => (e) => {\n    console.log(e)\n    if (!dirtyElements.current.has(ref)) {\n      dirtyElements.current.set(ref)\n      return\n    }\n    console.log(e)\n    const v = fieldValidation(ref)\n    if (validity !== v) {\n      setValidity((v) => !v)\n    }\n  }\n\n  const getValidators = (data, configValidators, builtInValidators) => {\n    if (!data) return\n    const f = {}\n    for (const key in data?.rules) {\n      console.log(key)\n      const t = checkForValidators(\n        data,\n        configValidators,\n        builtInValidators,\n        key\n      )\n      console.log(t)\n      if (t) {\n        f[key] = t\n      }\n    }\n    return f\n  }\n\n  const checkForValidators = (\n    data,\n    configValidators,\n    builtInValidators,\n    name\n  ) => {\n    if (data.customValidators?.[name]) {\n      return data.customValidators[name]\n    }\n    if (configValidators?.[name]) {\n      return configValidators[name]\n    }\n    if (builtInValidators[name]) {\n      return builtInValidators[name]\n    } else {\n      throw new Error(`no validation function with mane ${name}`)\n    }\n  }\n\n  const track = (elem, rules) => {\n    if (!elem) return\n    const ref = createRef()\n    if (elements.current.has(ref)) return\n\n    ref.current = elem\n    elements.current.set(elem, {\n      valid: true,\n      ...(rules && { data: rules })\n    })\n    // ref.current.onchange = keyup(ref)\n    // ref.current.onchange = partialOnChange(ref)\n    // ref.current.onfocus = partialOnFocus(ref)\n    ref.current.addEventListener('focus', partialOnFocus(ref))\n    ref.current.addEventListener('input', keyup(ref))\n  }\n\n  // const partialOnChange = (ref) => (e) => {\n  //    dirtyElements.current.set(ref)\n  //   ref.current.onchange = ''\n  // }\n\n  const partialOnFocus = (ref) => (e) => {\n    console.log('partial focus')\n    touchedElements.current.set(ref)\n    ref.current.onfocus = ''\n  }\n\n  return [track, submitForm, errors.current]\n}\n"],"names":["require","input","trim","length","email","test","minLen","len","toString","useValidator","config","console","log","elements","useRef","Map","touchedElements","dirtyElements","errors","customValidators","validity","setValidity","useState","submitForm","fn","e","preventDefault","el","fieldValidation","useEffect","current","ref","_isValid","data","get","validators","getValidators","builtInValidators","rules","msgs","key","validator","name","value","keyup","has","set","v","configValidators","f","t","checkForValidators","Error","track","elem","createRef","valid","addEventListener","partialOnFocus","onfocus"],"mappings":"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"}